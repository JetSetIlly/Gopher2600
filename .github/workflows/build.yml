name: build

on:
  push:
    branches: [ "**" ]

jobs:

  build-macos-intel:
    runs-on: macOS-13
    steps:
    - name: Install dependencies
      run: |
        brew install go
        brew install sdl2
    - uses: actions/checkout@v4
    - name: Build Gopher2600 (Intel)
      run: make release
    - name: Copy executable to package
      run: |
        mkdir -p package/Gopher2600.app/Contents/MacOS
        cp gopher2600_darwin_amd64 package/Gopher2600.app/Contents/MacOS/
    - name: Bundle SDL2 framework
      run: |
        SDL2_PREFIX=$(brew --prefix sdl2)
        echo "Inspecting Homebrew SDL2 prefix at $SDL2_PREFIX"
        ls -R "$SDL2_PREFIX"
        SDL2_FRAMEWORK="$SDL2_PREFIX/lib/SDL2.framework"
        if [ ! -d "$SDL2_FRAMEWORK" ]; then
          echo "::error::SDL2.framework not found at $SDL2_FRAMEWORK"
          exit 1
        fi
        mkdir -p package/Gopher2600.app/Contents/Frameworks
        ditto "$SDL2_FRAMEWORK" package/Gopher2600.app/Contents/Frameworks/SDL2.framework
    - name: Zip package
      run: |
        cd package
        zip -vr Gopher2600.zip Gopher2600.app
    - name: Upload package
      uses: actions/upload-artifact@v4
      with:
        name: Gopher2600-snapshot-macos
        path: package/Gopher2600.zip

  # build-macos-arm64:
  #   runs-on: macos-14
  #   steps:
  #   - name: Install dependencies
  #     run: |
  #       brew install go
  #       brew install sdl2
  #   - uses: actions/checkout@v4
  #   - name: Build Gopher2600 (ARM64)
  #     run: make release
  #   - name: Upload package
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: gopher2600_darwin_arm64
  #       path: gopher2600_darwin_arm64

# TODO: Add Windows and Linux builds